<!DOCTYPE html>
<!--
    Work Log App
    Version: 1.0.0
    Last Updated: 2026-01-30
    Description: Cloud-synced time tracking application with Google authentication
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Log</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .input-section input,
        .input-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .input-section input:focus,
        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-timer {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-timer:hover:not(:disabled) {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-timer:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-timer:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .log-entry {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }

        .log-entry:hover {
            transform: translateX(5px);
        }

        .log-time {
            font-size: 0.85em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .log-duration {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .log-task {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .log-description {
            color: #666;
            font-size: 0.95em;
        }

        .log-actions {
            margin-top: 10px;
            text-align: right;
        }

        .btn-delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #ff3838;
        }

        .btn-export:hover {
            background: #218838 !important;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            color: white;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .auth-card h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .auth-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .btn-signin {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-signin:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .btn-signout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .btn-signout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="auth-container" class="auth-container">
        <div class="auth-card">
            <h1>üìù Work Log</h1>
            <p>Sign in with your Google account to start tracking your work</p>
            <button class="btn-signin" onclick="signIn()">
                <svg width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
                Sign in with Google
            </button>
            <div id="auth-loading" class="hidden">
                <div class="loading-spinner"></div>
                <p style="margin-top: 10px;">Signing in...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="margin: 0;">üìù Work Log</h1>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <span id="user-name"></span>
                    <button class="btn-signout" onclick="signOut()">Sign Out</button>
                </div>
            </div>
            <p id="current-date"></p>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="task-count">0</div>
                <div class="stat-label">Tasks</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="time-elapsed">0h 0m</div>
                <div class="stat-label">Total Hours</div>
            </div>
        </div>

        <div class="card">
            <div class="input-section">
                <label for="task-name">What are you working on?</label>
                <input type="text" id="task-name" placeholder="e.g., Writing proposal, Fixing bug #123">
            </div>

            <div class="input-section">
                <label for="task-description">Description (optional)</label>
                <textarea id="task-description" placeholder="Add any additional details..."></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="input-section" style="margin-bottom: 0;">
                    <label for="start-time">Start Time</label>
                    <input type="time" id="start-time">
                </div>
                <div class="input-section" style="margin-bottom: 0;">
                    <label for="end-time">End Time</label>
                    <input type="time" id="end-time">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <button class="btn-timer" id="start-btn" onclick="startTimer()">‚ñ∂ Start Timer</button>
                <button class="btn-timer" id="stop-btn" onclick="stopTimer()" disabled style="opacity: 0.5;">‚èπ Stop Timer</button>
            </div>

            <div id="timer-display" style="text-align: center; font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 20px; display: none;">
                00:00:00
            </div>

            <button class="btn" onclick="addLog()">Log Activity</button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0; color: #333;">Activity Log</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="date-filter" onchange="renderLogs()" style="padding: 8px 15px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; cursor: pointer;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="btn-export" onclick="exportToCSV()" style="background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                        Export to Excel
                    </button>
                </div>
            </div>
            <div id="log-container"></div>
        </div>
    </div>
    </div>

    <div style="text-align: center; color: white; padding: 20px; font-size: 0.85em; opacity: 0.7;">
        Work Log App v1.0.0 | Last Updated: 2026-01-30
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASg7_Z2GQL3-BzV1uT3pBWT5bFpSCr8qg",
            authDomain: "t-tracker-72af5.firebaseapp.com",
            projectId: "t-tracker-72af5",
            storageBucket: "t-tracker-72af5.firebasestorage.app",
            messagingSenderId: "990510011053",
            appId: "1:990510011053:web:d00d322602fb4efe2bec24"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Current user
        let currentUser = null;

        // Initialize
        let logs = [];
        let firstLogTime = null;
        let timerStart = null;
        let timerInterval = null;
        let isTimerRunning = false;

        // Authentication
        console.log('Initializing auth...');
        
        auth.onAuthStateChanged((user) => {
            console.log('Auth state changed:', user ? user.email : 'no user');
            if (user) {
                currentUser = user;
                showApp();
                loadLogs();
            } else {
                currentUser = null;
                showAuth();
            }
        });

        // Handle redirect result - this runs when returning from Google login
        auth.getRedirectResult()
            .then((result) => {
                console.log('Redirect result:', result);
                if (result.user) {
                    console.log('Sign in successful:', result.user.email);
                } else if (result.credential) {
                    console.log('Has credential but no user yet');
                } else {
                    console.log('No redirect result (normal page load)');
                }
            })
            .catch((error) => {
                console.error('Sign in error:', error);
                alert('Sign in failed: ' + error.message);
                document.getElementById('auth-loading').classList.add('hidden');
            });

        function signIn() {
            document.getElementById('auth-loading').classList.remove('hidden');
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Use redirect for better compatibility
            auth.signInWithRedirect(provider);
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                auth.signOut();
            }
        }

        function showAuth() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Update user info
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email;
                const initial = displayName.charAt(0).toUpperCase();
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initial;
            }
            
            updateDate();
        }

        // Load logs from Firestore
        function loadLogs() {
            if (!currentUser) return;

            db.collection('logs')
                .doc(currentUser.uid)
                .collection('entries')
                .orderBy('startTime', 'desc')
                .get()
                .then((querySnapshot) => {
                    logs = [];
                    querySnapshot.forEach((doc) => {
                        logs.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    if (logs.length > 0) {
                        const sortedByTime = [...logs].sort((a, b) => 
                            new Date(a.startTime) - new Date(b.startTime)
                        );
                        firstLogTime = new Date(sortedByTime[0].startTime);
                    }
                    
                    renderLogs();
                    updateStats();
                })
                .catch((error) => {
                    console.error('Error loading logs:', error);
                    alert('Error loading logs: ' + error.message);
                });
        }

        // Save log to Firestore
        function saveLog(log) {
            if (!currentUser) return Promise.reject('No user logged in');

            const logData = {
                task: log.task,
                description: log.description,
                startTime: log.startTime,
                endTime: log.endTime,
                duration: log.duration,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            return db.collection('logs')
                .doc(currentUser.uid)
                .collection('entries')
                .doc(log.id.toString())
                .set(logData);
        }

        // Add a new log entry
        function addLog() {
            const taskName = document.getElementById('task-name').value.trim();
            const taskDescription = document.getElementById('task-description').value.trim();
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            if (!taskName) {
                alert('Please enter what you\'re working on');
                return;
            }

            if (!startTime || !endTime) {
                alert('Please enter both start and end times');
                return;
            }

            // Parse times
            const now = new Date();
            const [startHours, startMinutes] = startTime.split(':');
            const [endHours, endMinutes] = endTime.split(':');
            
            const startTimestamp = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHours, startMinutes);
            const endTimestamp = new Date(now.getFullYear(), now.getMonth(), now.getDate(), endHours, endMinutes);

            // Validate times
            if (startTimestamp >= endTimestamp) {
                alert('End time must be after start time');
                return;
            }

            if (endTimestamp > new Date()) {
                alert('Cannot log a future time');
                return;
            }

            // Calculate duration in minutes
            const durationMs = endTimestamp - startTimestamp;
            const durationMinutes = Math.floor(durationMs / (1000 * 60));
            
            if (!firstLogTime || startTimestamp < firstLogTime) {
                firstLogTime = startTimestamp;
            }

            const log = {
                id: Date.now(),
                task: taskName,
                description: taskDescription,
                startTime: startTimestamp.toISOString(),
                endTime: endTimestamp.toISOString(),
                duration: durationMinutes
            };

            // Save to Firestore
            saveLog(log)
                .then(() => {
                    logs.push(log);
                    logs.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
                    
                    renderLogs();
                    updateStats();

                    // Clear inputs
                    document.getElementById('task-name').value = '';
                    document.getElementById('task-description').value = '';
                    document.getElementById('start-time').value = '';
                    document.getElementById('end-time').value = '';
                })
                .catch((error) => {
                    console.error('Error saving log:', error);
                    alert('Error saving log: ' + error.message);
                });
        }

        // Delete a log entry
        function deleteLog(id) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }

            if (!currentUser) return;

            db.collection('logs')
                .doc(currentUser.uid)
                .collection('entries')
                .doc(id.toString())
                .delete()
                .then(() => {
                    logs = logs.filter(log => log.id !== id);
                    
                    if (logs.length === 0) {
                        firstLogTime = null;
                    } else {
                        const sortedByTime = [...logs].sort((a, b) => 
                            new Date(a.startTime) - new Date(b.startTime)
                        );
                        firstLogTime = new Date(sortedByTime[0].startTime);
                    }
                    
                    renderLogs();
                    updateStats();
                })
                .catch((error) => {
                    console.error('Error deleting log:', error);
                    alert('Error deleting log: ' + error.message);
                });
        }

        // Render all logs
        function renderLogs() {
            const container = document.getElementById('log-container');
            const filter = document.getElementById('date-filter').value;
            
            // Filter logs based on selection
            const filteredLogs = getFilteredLogs(filter);

            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>No activities logged for this period.<br>Start tracking your work!</p>
                    </div>
                `;
                return;
            }

            // Group logs by date
            const logsByDate = {};
            filteredLogs.forEach(log => {
                const date = new Date(log.startTime).toDateString();
                if (!logsByDate[date]) {
                    logsByDate[date] = [];
                }
                logsByDate[date].push(log);
            });

            // Render grouped logs
            let html = '';
            Object.keys(logsByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const dateObj = new Date(date);
                const isToday = dateObj.toDateString() === new Date().toDateString();
                const dateLabel = isToday ? 'Today' : dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric',
                    year: dateObj.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                });

                // Calculate total duration for the day
                const dayTotal = logsByDate[date].reduce((sum, log) => sum + log.duration, 0);
                const dayHours = Math.floor(dayTotal / 60);
                const dayMinutes = dayTotal % 60;
                const dayDuration = dayHours > 0 ? `${dayHours}h ${dayMinutes}m` : `${dayMinutes}m`;

                html += `
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;">
                            <h3 style="margin: 0; color: #333; font-size: 1.1em;">${dateLabel}</h3>
                            <span style="color: #667eea; font-weight: 600;">${dayDuration} total</span>
                        </div>
                `;

                logsByDate[date].forEach(log => {
                    const startTime = new Date(log.startTime);
                    const endTime = new Date(log.endTime);
                    
                    const startString = startTime.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    
                    const endString = endTime.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });

                    const hours = Math.floor(log.duration / 60);
                    const minutes = log.duration % 60;
                    const durationString = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                    html += `
                        <div class="log-entry">
                            <div class="log-time">
                                ${startString} - ${endString}
                                <span class="log-duration">${durationString}</span>
                            </div>
                            <div class="log-task">${escapeHtml(log.task)}</div>
                            ${log.description ? `<div class="log-description">${escapeHtml(log.description)}</div>` : ''}
                            <div class="log-actions">
                                <button class="btn-delete" onclick="deleteLog(${log.id})">Delete</button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        // Get filtered logs based on date range
        function getFilteredLogs(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return logs.filter(log => {
                const logDate = new Date(log.startTime);
                const logDay = new Date(logDate.getFullYear(), logDate.getMonth(), logDate.getDate());
                
                switch(filter) {
                    case 'today':
                        return logDay.getTime() === today.getTime();
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return logDay >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return logDay >= monthAgo;
                    case 'all':
                        return true;
                    default:
                        return true;
                }
            }).sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        }

        // Update statistics
        function updateStats() {
            const filter = document.getElementById('date-filter').value;
            const filteredLogs = getFilteredLogs(filter);
            
            document.getElementById('task-count').textContent = filteredLogs.length;

            if (filteredLogs.length > 0) {
                // Calculate total duration for filtered logs
                const totalMinutes = filteredLogs.reduce((sum, log) => sum + log.duration, 0);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                document.getElementById('time-elapsed').textContent = `${hours}h ${minutes}m`;
            } else {
                document.getElementById('time-elapsed').textContent = '0h 0m';
            }
        }

        // Start timer
        function startTimer() {
            if (isTimerRunning) return;

            timerStart = new Date();
            isTimerRunning = true;

            // Set start time field
            const startTimeString = timerStart.toTimeString().slice(0, 5);
            document.getElementById('start-time').value = startTimeString;

            // Update UI
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').style.opacity = '0.5';
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('stop-btn').style.opacity = '1';
            document.getElementById('timer-display').style.display = 'block';

            // Start interval to update display
            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();
        }

        // Stop timer
        function stopTimer() {
            if (!isTimerRunning) return;

            const timerEnd = new Date();
            isTimerRunning = false;

            // Set end time field
            const endTimeString = timerEnd.toTimeString().slice(0, 5);
            document.getElementById('end-time').value = endTimeString;

            // Clear interval
            clearInterval(timerInterval);
            timerInterval = null;

            // Update UI
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').style.opacity = '1';
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('stop-btn').style.opacity = '0.5';
            document.getElementById('timer-display').style.display = 'none';

            timerStart = null;
        }

        // Update timer display
        function updateTimerDisplay() {
            if (!timerStart) return;

            const now = new Date();
            const diff = now - timerStart;

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
        }

        // Export logs to CSV
        function exportToCSV() {
            const filter = document.getElementById('date-filter').value;
            const filteredLogs = getFilteredLogs(filter);
            
            if (filteredLogs.length === 0) {
                alert('No logs to export');
                return;
            }

            // Sort logs by timestamp (oldest first for chronological order)
            const sortedLogs = [...filteredLogs].sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            // Create CSV header
            let csv = 'Date,Start Time,End Time,Duration (minutes),Task,Description\n';

            // Add each log entry
            sortedLogs.forEach(log => {
                const startDate = new Date(log.startTime);
                const endDate = new Date(log.endTime);
                
                const dateString = startDate.toLocaleDateString('en-US');
                const startTimeString = startDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                const endTimeString = endDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                // Escape fields that contain commas or quotes
                const task = escapeCSV(log.task);
                const description = escapeCSV(log.description || '');

                csv += `${dateString},${startTimeString},${endTimeString},${log.duration},${task},${description}\n`;
            });

            // Create a blob and download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const today = new Date().toISOString().split('T')[0];
            const filterSuffix = filter !== 'all' ? `-${filter}` : '';
            link.setAttribute('href', url);
            link.setAttribute('download', `work-log-${today}${filterSuffix}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Escape CSV fields
        function escapeCSV(field) {
            if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                return `"${field.replace(/"/g, '""')}"`;
            }
            return field;
        }

        // Display current date
        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = new Date().toLocaleDateString('en-US', options);
            document.getElementById('current-date').textContent = dateString;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Allow Enter key to submit
        document.getElementById('task-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addLog();
            }
        });

        // Update stats when filter changes
        document.getElementById('date-filter').addEventListener('change', function() {
            updateStats();
        });

        // Initialize on load
        updateDate();
    </script>
</body>
</html>
